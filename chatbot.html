<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmAI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --wood-light: #e3c19f;
            --wood-dark: #c19a6b;
            --wood-text: #5d4037;
            --green-light: #e8f5e9;
            --green-dark: #388e3c;
            --green-text: #1b5e20;
            --sky-gradient-start: #dcedc8;
            --sky-gradient-end: #a5d6a7;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1444930694458-04f474b3aa4d?q=80&w=2938&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        
        .font-kalam { font-family: 'Kalam', cursive; }

        .wood-frame {
            background-color: var(--wood-light);
            border: 12px solid #a1887f; /* A darker wood color for the outer frame */
            border-radius: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), inset 0 0 15px rgba(0,0,0,0.3);
            padding: 12px;
            display: flex;
            flex-direction: column;
            height: 95vh;
            max-height: 800px;
        }

        .inner-container {
            background-color: #f7f3e9; /* A warm, earthy off-white */
            border-radius: 28px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
            background-image: linear-gradient(rgba(247, 243, 233, 0.9), rgba(247, 243, 233, 0.9)), url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=2832&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }

        .header {
            background: linear-gradient(135deg, var(--sky-gradient-start), var(--sky-gradient-end));
            border-bottom: 2px solid rgba(255,255,255,0.5);
            padding: 1.5rem;
            border-radius: 28px 28px 0 0;
        }

        .wood-btn {
            background-color: var(--wood-light);
            border: 2px solid var(--wood-dark);
            color: var(--wood-text);
            font-weight: 600;
            border-radius: 16px;
            padding: 0.5rem 1.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15), inset 0 -2px 1px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
        }
        .wood-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 0 -2px 1px rgba(0,0,0,0.1);
        }
        .wood-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15), inset 0 2px 1px rgba(0,0,0,0.1);
        }
        .wood-btn-sm {
            padding: 0.3rem 1rem;
            border-radius: 12px;
        }

        #chat-window {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }

        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: transparent; }
        #chat-window::-webkit-scrollbar-thumb {
            background-color: var(--wood-dark);
            border-radius: 10px;
        }
        
        .chat-bubble { animation: slide-in 0.4s ease-out forwards; }
        @keyframes slide-in {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ai-bubble {
            background-color: var(--green-light);
            border: 1px solid #c8e6c9;
            color: var(--green-text);
            border-radius: 20px;
            border-top-left-radius: 4px;
        }

        .input-container {
            background-color: rgba(247, 243, 233, 0.7);
            padding: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }

        .input-wrapper {
            background-color: #fff;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            padding: 0.25rem;
        }

        #user-input {
            border: none;
            outline: none;
            background: transparent;
            flex-grow: 1;
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
        }

        .mic-btn, .send-btn {
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .mic-btn { background-color: #f0f4c3; color: var(--green-dark); }
        .mic-btn.recording-pulse { background-color: #ef5350; color: white; animation: pulse 1.5s infinite; }
        .send-btn { background: linear-gradient(135deg, #81c784, #4caf50); color: white; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 83, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 83, 80, 0); }
        }
        
        .dot-flashing {
            position: relative; width: 8px; height: 8px;
            border-radius: 5px; background-color: var(--green-dark); color: var(--green-dark);
            animation: dotFlashing 1s infinite linear alternate; animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ''; display: inline-block; position: absolute; top: 0;
        }
        .dot-flashing::before {
            left: -12px; width: 8px; height: 8px; border-radius: 5px;
            background-color: var(--green-dark); color: var(--green-dark);
            animation: dotFlashing 1s infinite alternate; animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 12px; width: 8px; height: 8px; border-radius: 5px;
            background-color: var(--green-dark); color: var(--green-dark);
            animation: dotFlashing 1s infinite alternate; animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: var(--green-dark); opacity: 0.5; }
            50%, 100% { background-color: var(--green-dark); opacity: 1; }
        }
        
        .speak-btn { cursor: pointer; color: var(--green-dark); transition: transform 0.2s; }
        .speak-btn:hover { transform: scale(1.2); }
        .speak-btn.speaking { color: #f59e0b; animation: speaking-pulse 1s infinite; }
        @keyframes speaking-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-xl wood-frame">
        <div class="inner-container">
            <!-- Header -->
            <header class="header">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <!-- Corrected: Replaced icon with a more thematic sprout icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-800"><path d="M7 20h10"/><path d="M10 20c0-4.42 2.69-8 6-8h0c-3.31 0-6-3.58-6-8h0c-3.31 0-6 3.58-6 8h0c3.31 0 6 3.58 6 8Z"/></svg>
                        <div>
                            <h1 class="text-3xl font-kalam font-bold text-green-900" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">FarmAI</h1>
                            <p class="text-sm text-green-800" data-translate-key="friendly_guide">Your natural farming guide</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                         <label for="language-selector" class="sr-only">Select Language</label>
                         <select id="language-selector" class="wood-btn wood-btn-sm flex items-center gap-1.5" aria-label="Select Language">
                            <option value="en">English</option>
                            <option value="hi">हिन्दी</option>
                            <option value="ml">മലയാളം</option>
                        </select>
                    </div>
                </div>
            </header>

            <div class="px-6 pt-4 flex items-center justify-center gap-4">
                <button id="clear-chat-btn" class="wood-btn flex-1" data-translate-key="new_chat">New Chat</button>
                <button id="back-to-dashboard-btn" class="wood-btn flex-1" data-translate-key="back_to_dashboard">Back to dashboard</button>
            </div>

            <!-- Chat Window -->
            <main id="chat-window" class="flex-1 space-y-6">
                <!-- Messages dynamically inserted here -->
            </main>
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden px-6 pb-2">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-2xl flex-shrink-0 shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M14 16.5V18a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-3.5a2.5 2.5 0 0 1 5 0V18"/><path d="M20 12V6a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h2"/><path d="m18 8 2 3-2 2"/><path d="m6 12 2-3-2-2"/></svg>
                    </div>
                    <div class="ai-bubble p-4">
                        <div class="dot-flashing"></div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <footer class="input-container">
                <div id="chat-form" class="input-wrapper">
                    <input type="text" id="user-input" placeholder="Ask about farming..." data-translate-key="ask_about_farming">
                    <button type="button" id="mic-btn" aria-label="Voice input" class="mic-btn mr-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
                    </button>
                    <button type="button" id="send-btn" aria-label="Send message" class="send-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <script src="logic.js"></script>
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // Use proxy endpoint for API calls
        const API_URL = `/api/gemini`;

        // --- Firebase Constants ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        // --- DOM Elements ---
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const languageSelector = document.getElementById('language-selector');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

        // --- TRANSLATIONS ---
        const translations = {
            "en": {
                "friendly_guide": "Your natural farming guide", "new_chat": "New Chat", "back_to_dashboard": "Back to dashboard", "ask_about_farming": "Ask about farming...", "welcome_message": "Hello there! I'm FarmAI, your friendly guide. Ask me about organic farming, plant care, soil health, or sustainable practices.", "listening": "Listening...", "speech_not_supported": "Your browser doesn't support voice input. You can type your questions instead!", "connection_error": "Sorry, I'm having trouble connecting to my AI brain.", "api_key_missing": "API Key is missing. Please get a key from Google AI Studio and add it to the 'API_KEY' variable in the code to enable the chat.",
                "general_advice_instead": "Here's some general advice instead:",
                "fallback_responses": {
                    "corn": "For growing corn, you'll want well-drained soil with plenty of organic matter. Plant when soil temperatures reach 60°F (15°C). Corn needs about 1-2 inches of water per week and full sun. 🌽",
                    "tomato": "Tomatoes love full sun and warm temperatures above 60°F. Plant after the last frost, about 2-3 feet apart. They need consistent watering but don't let the leaves get wet. Stake them for support! 🍅",
                    "pest": "For pest control, try companion planting first - things like marigolds repel many pests. If needed, use organic pesticides like neem oil. Always identify the pest before treating! 🐛",
                    "soil": "Soil is everything! Test your soil pH - most crops prefer 6.0-7.0. Add organic matter like compost to improve fertility and structure. Rotate crops to keep soil healthy! 🌱",
                    "default": "I can help with questions about crops, livestock, farming techniques, pest control, irrigation, soil management, and more. What would you like to know about farming today? 🌾🚜"
                }
            },
            "hi": {
                "friendly_guide": "आपकी प्राकृतिक खेती गाइड", "new_chat": "नई चैट", "back_to_dashboard": "डैशबोर्ड पर वापस", "ask_about_farming": "खेती के बारे में पूछें...", "welcome_message": "नमस्ते! मैं फार्मएआई हूं, आपका मित्रवत गाइड। मुझसे जैविक खेती, पौधों की देखभाल, मिट्टी के स्वास्थ्य, या स्थायी प्रथाओं के बारे में पूछें।", "listening": "सुन रहा हूँ...", "speech_not_supported": "आपका ब्राउज़र वॉयस इनपुट का समर्थन नहीं करता है। आप इसके बजाय अपने प्रश्न टाइप कर सकते हैं!", "connection_error": "क्षमा करें, मुझे अपने AI मस्तिष्क से जुड़ने में समस्या आ रही है।",
                "general_advice_instead": "इसके बजाय यहाँ कुछ सामान्य सलाह दी गई है:",
                "fallback_responses": {
                    "corn": "मक्का उगाने के लिए, आपको अच्छी जल निकासी वाली मिट्टी चाहिए जिसमें भरपूर मात्रा में कार्बनिक पदार्थ हों। जब मिट्टी का तापमान 60°F (15°C) तक पहुँच जाए तब पौधे लगाएँ। मक्के को प्रति सप्ताह लगभग 1-2 इंच पानी और पूरी धूप की आवश्यकता होती है। 🌽",
                    "tomato": "टमाटर को पूरी धूप और 60°F से ऊपर गर्म तापमान पसंद है। आखिरी पाले के बाद लगभग 2-3 फीट की दूरी पर पौधे लगाएँ। उन्हें लगातार पानी देने की आवश्यकता होती है, लेकिन पत्तियों को गीला न होने दें। सहारे के लिए उन्हें डंडे से बांधें! 🍅",
                    "pest": "कीट नियंत्रण के लिए, पहले साथी रोपण का प्रयास करें - गेंदे जैसी चीजें कई कीटों को दूर भगाती हैं। यदि आवश्यक हो, तो नीम के तेल जैसे जैविक कीटनाशकों का उपयोग करें। उपचार करने से पहले हमेशा कीट की पहचान करें! 🐛",
                    "soil": "मिट्टी ही सब कुछ है! अपनी मिट्टी का पीएच परीक्षण करें - अधिकांश फसलें 6.0-7.0 पसंद करती हैं। उर्वरता और संरचना में सुधार के लिए खाद जैसे कार्बनिक पदार्थ डालें। मिट्टी को स्वस्थ रखने के लिए फसलें घुमाएँ! 🌱",
                    "default": "मैं फसलों, पशुधन, कृषि तकनीकों, कीट नियंत्रण, सिंचाई, मिट्टी प्रबंधन, और बहुत कुछ के बारे में सवालों में मदद कर सकता हूँ। आज आप खेती के बारे में क्या जानना चाहेंगे? 🌾🚜"
                }
            },
            "ml": {
                "friendly_guide": "നിങ്ങളുടെ പ്രകൃതിദത്ത കൃഷി സഹായി", "new_chat": "പുതിയ ചാറ്റ്", "back_to_dashboard": "ഡാഷ്‌ബോർഡിലേക്ക് മടങ്ങുക", "ask_about_farming": "കൃഷിയെക്കുറിച്ച് ചോദിക്കുക...", "welcome_message": "നമസ്കാരം! ഞാൻ ഫാംഎഐ, നിങ്ങളുടെ സൗഹൃദപരമായ വഴികാട്ടി. ജൈവകൃഷി, സസ്യ സംരക്ഷണം, മണ്ണിന്റെ ആരോഗ്യം, അല്ലെങ്കിൽ സുസ്ഥിരമായ രീതികളെക്കുറിച്ച് എന്നോട് ചോദിക്കൂ.", "listening": "കേൾക്കുന്നു...", "speech_not_supported": "നിങ്ങളുടെ ബ്രൗസർ വോയ്‌സ് ഇൻപുട്ടിനെ പിന്തുണയ്ക്കുന്നില്ല. പകരം നിങ്ങളുടെ ചോദ്യങ്ങൾ ടൈപ്പ് ചെയ്യാം!", "connection_error": "ക്ഷമിക്കണം, എനിക്ക് എന്റെ AI തലച്ചോറുമായി ബന്ധപ്പെടാൻ കഴിയുന്നില്ല.",
                "general_advice_instead": "പകരമായി ഇതാ ചില പൊതുവായ ഉപദേശങ്ങൾ:",
                "fallback_responses": {
                    "corn": "ചോളം വളർത്തുന്നതിന്, ധാരാളം ജൈവാംശമുള്ള, നല്ല നീർവാർച്ചയുള്ള മണ്ണ് ആവശ്യമാണ്. മണ്ണിന്റെ താപനില 60°F (15°C) എത്തുമ്പോൾ നടുക. ചോളത്തിന് ആഴ്ചയിൽ ഏകദേശം 1-2 ഇഞ്ച് വെള്ളവും പൂർണ്ണ സൂര്യപ്രകാശവും ആവശ്യമാണ്. 🌽",
                    "tomato": "തക്കാളിക്ക് പൂർണ്ണ സൂര്യപ്രകാശവും 60°F-ന് മുകളിലുള്ള ഊഷ്മളമായ താപനിലയും ഇഷ്ടമാണ്. അവസാനത്തെ മഞ്ഞിന് ശേഷം ഏകദേശം 2-3 അടി അകലത്തിൽ നടുക. അവയ്ക്ക് സ്ഥിരമായി നനയ്ക്കേണ്ടതുണ്ട്, പക്ഷേ ഇലകൾ നനയാൻ അനുവദിക്കരുത്. താങ്ങിനായി കമ്പുകൾ സ്ഥാപിക്കുക! 🍅",
                    "pest": "കീടനിയന്ത്രണത്തിനായി, ആദ്യം സഹചാരി നടീൽ പരീക്ഷിക്കുക - ചെണ്ടുമല്ലി പോലുള്ളവ പല കീടങ്ങളെയും അകറ്റുന്നു. ആവശ്യമെങ്കിൽ, വേപ്പെണ്ണ പോലുള്ള ജൈവ കീടനാശിനികൾ ഉപയോഗിക്കുക. ചികിത്സിക്കുന്നതിന് മുമ്പ് എപ്പോഴും കീടത്തെ തിരിച്ചറിയുക! 🐛",
                    "soil": "മണ്ണാണ് എല്ലാം! നിങ്ങളുടെ മണ്ണിന്റെ പിഎച്ച് പരിശോധിക്കുക - മിക്ക വിളകളും 6.0-7.0 ഇഷ്ടപ്പെടുന്നു. ഫലഭൂയിഷ്ഠതയും ഘടനയും മെച്ചപ്പെടുത്തുന്നതിന് കമ്പോസ്റ്റ് പോലുള്ള ജൈവവസ്തുക്കൾ ചേർക്കുക. മണ്ണിന്റെ ആരോഗ്യം നിലനിർത്താൻ വിളകൾ മാറ്റി നടുക! 🌱",
                    "default": "വിളകൾ, കന്നുകാലികൾ, കൃഷിരീതികൾ, കീടനിയന്ത്രണം, ജലസേചനം, മണ്ണ് പരിപാലനം എന്നിവയെക്കുറിച്ചുള്ള ചോദ്യങ്ങൾക്ക് എനിക്ക് സഹായിക്കാനാകും. ഇന്ന് കൃഷിയെക്കുറിച്ച് നിങ്ങൾക്കെന്താണ് അറിയേണ്ടത്? 🌾🚜"
                }
            }
        };
        
        // --- STATE MANAGEMENT ---
        let chatHistory = [];
        let currentLanguage = 'en';
        let db, auth, userId, unsubscribeChat;

        // --- SPEECH & SYNTHESIS SETUP ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speechSynthesis = window.speechSynthesis;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
        } 
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initialize);

        function initialize() {
            setupStaticEventListeners();
            
            if (firebaseConfig) {
                initializeFirebase();
            } else {
                console.error("Firebase config is missing! Running in offline mode.");
                updateChatHistory(translations[currentLanguage].welcome_message, 'model');
                setTimeout(() => {
                    updateChatHistory("Warning: App not configured. Chat history will not be saved.", 'model');
                }, 1000);
            }

            if (recognition) {
                setupRecognition();
            } else {
                handleSpeechRecognitionNotSupported();
            }
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await loadUserSettings();
                        setupChatListener();
                    } else {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                updateChatHistory("Failed to connect to backend services. Running in offline mode.", 'model');
            }
        }

        // --- EVENT LISTENERS ---
        function setupStaticEventListeners() {
            chatWindow.addEventListener('click', (e) => {
                if (e.target.closest('.speak-btn')) {
                    const textToSpeak = e.target.closest('.speak-btn').dataset.text;
                    speakMessage(textToSpeak, currentLanguage, e.target.closest('.speak-btn'));
                }
            });

            languageSelector.addEventListener('change', (e) => {
                changeLanguage(e.target.value);
            });

            micBtn.addEventListener('click', () => {
                if (!recognition) return;
                if (speechSynthesis.speaking) speechSynthesis.cancel();
                if (!isRecording) {
                    recognition.start();
                } else {
                    recognition.stop();
                }
            });

            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const message = userInput.value.trim();
                    if (message) sendMessage(message);
                }
            });

            sendBtn.addEventListener('click', () => {
                const message = userInput.value.trim();
                if (message) sendMessage(message);
            });

            clearChatBtn.addEventListener('click', () => {
                speechSynthesis.cancel();
                chatHistory = []; // Clear local history first
                const welcomeMsg = translations[currentLanguage].welcome_message;
                updateChatHistory(welcomeMsg, 'model');
            });
            
            backToDashboardBtn.addEventListener('click', () => {
                // This would navigate to a different page in a multi-page setup.
                // For a single page app, it could be repurposed or removed.
                // We'll leave the original functionality for now.
                window.location.href = 'index.html';
            });
        }

        // --- CORE FUNCTIONS ---
        function sendMessage(message) {
            updateChatHistory(message, 'user');
            userInput.value = '';
            showLoadingIndicator();
            callGeminiAPI();
        }
        
        async function callGeminiAPI() {
            const selectedLanguageName = languageSelector.options[languageSelector.selectedIndex].text;
            const systemPrompt = `You are FarmAI, a friendly and knowledgeable guide specializing in natural and organic farming. Your persona is encouraging, patient, and passionate about sustainable agriculture. Provide practical, easy-to-understand advice on topics like organic pest control, soil health, companion planting, and permaculture. Use nature-related emojis 🌿, 🌱, 🥕, 🐞. You MUST respond in ${selectedLanguageName}.`;

            // Improvement: Filter out the initial system message from the history sent to the model
            const filteredHistory = chatHistory.filter(message =>
                message.parts[0].text !== translations['en'].welcome_message &&
                message.parts[0].text !== translations['hi'].welcome_message &&
                message.parts[0].text !== translations['ml'].welcome_message
            );

            const payload = {
                contents: filteredHistory,
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();

                // Handle cases where the API response might be blocked or empty
                if (!result.candidates || result.candidates.length === 0) {
                    console.error("API Response was blocked or empty:", result);
                    throw new Error("No content received from API.");
                }

                const text = result.candidates[0]?.content?.parts?.[0]?.text;

                if (text) {
                    updateChatHistory(text, 'model');
                } else {
                    throw new Error("Empty text in API response.");
                }

            } catch (error) {
                console.error('Error calling Gemini API:', error);
                const connectionErrorMsg = translations[currentLanguage].connection_error;
                const lastUserQuery = chatHistory.filter(m => m.role === 'user').pop()?.parts?.[0]?.text || "farming";
                const fallbackResponse = getFallbackResponse(lastUserQuery);
                const generalAdviceHeader = translations[currentLanguage].general_advice_instead;
                const combinedMessage = `${connectionErrorMsg} 🤖\n\n${generalAdviceHeader}\n\n${fallbackResponse}`;
                updateChatHistory(combinedMessage, 'model');
            } finally {
                hideLoadingIndicator();
            }
        }
        
        function speakMessage(text, langCode, btnElement) {
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            document.querySelectorAll('.speak-btn.speaking').forEach(el => el.classList.remove('speaking'));

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            utterance.onstart = () => btnElement.classList.add('speaking');
            utterance.onend = () => btnElement.classList.remove('speaking');
            utterance.onerror = () => {
                 btnElement.classList.remove('speaking');
                 console.error("Speech synthesis error.");
            };
            speechSynthesis.speak(utterance);
        }

        // --- UI & HISTORY ---
        function displayMessage(message, role) {
            const messageText = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            const messageElement = document.createElement('div');
            messageElement.className = "flex items-start gap-3 chat-bubble";
            
            if (role === 'user') {
                messageElement.classList.add("justify-end");
                messageElement.innerHTML = `
                    <div class="bg-white p-4 rounded-2xl rounded-tr-none max-w-md shadow-sm border">
                        <p class="text-gray-800">${messageText}</p>
                    </div>
                    <div class="w-10 h-10 bg-sky-100 text-sky-700 rounded-full flex items-center justify-center text-2xl flex-shrink-0 shadow-sm">🧑‍🌾</div>`;
            } else {
                messageElement.innerHTML = `
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-2xl flex-shrink-0 shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M7 20h10"/><path d="M10 20c0-4.42 2.69-8 6-8h0c-3.31 0-6-3.58-6-8h0c-3.31 0-6 3.58-6 8h0c3.31 0 6 3.58 6 8Z"/></svg>
                    </div>
                    <div class="ai-bubble p-4 max-w-md">
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-bold">FarmAI</p>
                            <button class="speak-btn" data-text="${message.replace(/"/g, '&quot;')}">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-1.414 1.414A6.47 6.47 0 0 1 12.026 8c0 1.767-.683 3.392-1.904 4.604l1.414 1.406z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.026 8a6.48 6.48 0 0 0-1.905-4.596l-1.414 1.414A4.49 4.49 0 0 1 10.026 8a4.49 4.49 0 0 1-1.318 3.182l1.414 1.414z"/><path d="M8.707 11.182A4.49 4.49 0 0 0 10.026 8a4.49 4.49 0 0 0-1.319-3.182L7.293 6.232A2.49 2.49 0 0 1 8.026 8a2.49 2.49 0 0 1-.732 1.768l1.414 1.414z"/><path d="M6 7.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5z"/></svg>
                            </button>
                        </div>
                        <p>${messageText}</p>
                    </div>`;
            }
            chatWindow.appendChild(messageElement);
            scrollToBottom();
        }
        
        function updateChatHistory(message, role) {
            // Prevent duplicate welcome messages from being added rapidly
            const welcomeMsg = translations[currentLanguage].welcome_message;
            if (role === 'model' && message === welcomeMsg && chatHistory.some(m => m.parts[0].text === message)) {
                return;
            }
            chatHistory.push({ role: role, parts: [{ text: message }] });
            saveChatHistory();
            // In offline mode, we must manually re-render
            if (!firebaseConfig) {
                renderChatHistory();
            }
        }
        
        async function saveChatHistory() { 
            if (!userId || !db) return;
            const chatRef = doc(db, 'artifacts', appId, 'users', userId, 'chat', 'history');
            try {
                await setDoc(chatRef, { messages: chatHistory });
            } catch (error) {
                console.error("Error saving chat history:", error);
            }
        }

        function setupChatListener() {
            if (unsubscribeChat) unsubscribeChat();
            if (!userId || !db) return;

            const chatRef = doc(db, 'artifacts', appId, 'users', userId, 'chat', 'history');
            unsubscribeChat = onSnapshot(chatRef, (docSnap) => {
                const messages = docSnap.exists() && docSnap.data().messages ? docSnap.data().messages : [];
                chatHistory = messages;
                
                if (chatHistory.length === 0) {
                    // If history is empty on the backend, start a new one
                    updateChatHistory(translations[currentLanguage].welcome_message, 'model');
                } else {
                    renderChatHistory();
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                updateChatHistory("Error loading chat history.", 'model');
            });
        }
        
        function renderChatHistory() {
            chatWindow.innerHTML = '';
            chatHistory.forEach(item => displayMessage(item.parts[0].text, item.role));
            scrollToBottom();
        }

        // --- LANGUAGE & TRANSLATION ---
        async function changeLanguage(langCode) {
            currentLanguage = langCode;
            if (recognition) recognition.lang = langCode === 'en' ? 'en-US' : langCode === 'hi' ? 'hi-IN' : 'ml-IN';
            translateUI();
            await saveUserSettings();

            // Start a new chat in the new language
            speechSynthesis.cancel();
            chatHistory = [];
            updateChatHistory(translations[currentLanguage].welcome_message, 'model');
        }

        async function saveUserSettings() {
            if (!userId || !db) return;
            const settingsRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'userSettings');
            await setDoc(settingsRef, { language: currentLanguage }, { merge: true });
        }

        async function loadUserSettings() {
            if (!userId || !db) return;
            const settingsRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'userSettings');
            try {
                const docSnap = await getDoc(settingsRef);
                currentLanguage = (docSnap.exists() && docSnap.data().language) ? docSnap.data().language : 'en';
            } catch(e) {
                console.error("Could not load user settings", e);
                currentLanguage = 'en';
            } finally {
                languageSelector.value = currentLanguage;
                translateUI();
            }
        }
        
        function translateUI() {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const translation = translations[currentLanguage][key];
                if (el.tagName === 'INPUT') {
                    el.placeholder = translation;
                } else {
                    el.textContent = translation;
                }
            });
        }
        
        // --- SPEECH RECOGNITION ---
        function setupRecognition() {
            recognition.lang = currentLanguage === 'en' ? 'en-US' : currentLanguage === 'hi' ? 'hi-IN' : 'ml-IN';

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('recording-pulse');
                userInput.placeholder = translations[currentLanguage].listening;
            };
            recognition.onend = () => {
                isRecording = false;
                micBtn.classList.remove('recording-pulse');
                userInput.placeholder = translations[currentLanguage].ask_about_farming;
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                if (transcript) sendMessage(transcript);
            };
            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
            };
        }
        
        function handleSpeechRecognitionNotSupported() {
            micBtn.disabled = true;
            micBtn.style.cssText = 'background-color: #e0e0e0; cursor: not-allowed;';
            updateChatHistory(translations[currentLanguage].speech_not_supported, 'model');
        }

        // --- UTILITIES ---
        function showLoadingIndicator() {
            loadingIndicator.classList.remove('hidden');
            scrollToBottom();
        }

        function hideLoadingIndicator() {
            loadingIndicator.classList.add('hidden');
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Fallback responses when API is not available
        function getFallbackResponse(userQuery) {
            const query = userQuery.toLowerCase();
            const fallbacks = translations[currentLanguage].fallback_responses;
            if (query.includes('corn') || query.includes('maize') || query.includes('मक्का') || query.includes('ചോളം')) {
                return fallbacks.corn;
            } else if (query.includes('tomato') || query.includes('tomatoes') || query.includes('टमाटर') || query.includes('തക്കാളി')) {
                return fallbacks.tomato;
            } else if (query.includes('pest') || query.includes('insect') || query.includes('कीट') || query.includes('കീട')) {
                return fallbacks.pest;
            } else if (query.includes('soil') || query.includes('मिट्टी') || query.includes('മണ്ണ്')) {
                return fallbacks.soil;
            } else {
                return fallbacks.default;
            }
        }
    </script>
</body>
</html>

