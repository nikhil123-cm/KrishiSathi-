<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil+ Fertilizer Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .solution-card p {
            margin-bottom: 0.75rem;
        }
        .solution-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #166534; /* darker green */
        }
        .solution-card ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .solution-card li {
            margin-bottom: 0.25rem;
        }
        /* Simple spinner animation */
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #10B981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">

        <!-- Header Section -->
        <header class="mb-8">
            <div class="relative flex items-center justify-center py-4">
                 <button id="dashboard-btn" class="absolute left-0 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                    Dashboard
                </button>
                <div class="text-center">
                    <h1 class="text-4xl sm:text-5xl font-bold text-green-800">Soil+</h1>
                </div>
            </div>
            <p class="text-gray-600 mt-2 text-lg text-center">Your AI-powered guide to optimal crop nutrition.</p>
        </header>

        <!-- Form Section -->
        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Crop Selection -->
                <div>
                    <label for="crop-selection" class="block text-sm font-medium text-gray-700 mb-2">Select Crop</label>
                    <select id="crop-selection" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        <option>Wheat</option>
                        <option>Rice</option>
                        <option>Corn (Maize)</option>
                        <option>Sugarcane</option>
                        <option>Cotton</option>
                        <option>Soybean</option>
                        <option>Potato</option>
                        <option>Tomato</option>
                        <option>Onion</option>
                    </select>
                </div>

                <!-- Soil Type Selection -->
                <div>
                    <label for="soil-type" class="block text-sm font-medium text-gray-700 mb-2">Select Soil Type</label>
                    <select id="soil-type" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        <option>Alluvial Soil</option>
                        <option>Black Soil (Regur)</option>
                        <option>Red and Yellow Soil</option>
                        <option>Laterite Soil</option>
                        <option>Arid (Desert) Soil</option>
                        <option>Saline Soil</option>
                        <option>Peaty Soil</option>
                        <option>Forest Soil</option>
                    </select>
                </div>

                <!-- Land Amount -->
                <div>
                    <label for="land-amount" class="block text-sm font-medium text-gray-700 mb-2">Amount of Land (Acres)</label>
                    <input type="number" id="land-amount" value="1" min="0.1" step="0.1" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition" placeholder="e.g., 5.5">
                </div>

                <!-- Crop Stage Selection -->
                <div>
                    <label for="crop-stage" class="block text-sm font-medium text-gray-700 mb-2">Select Crop Stage</label>
                    <select id="crop-stage" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        <option>Sowing / Germination</option>
                        <option>Vegetative Growth</option>
                        <option>Flowering Stage</option>
                        <option>Fruiting / Maturity Stage</option>
                    </select>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="mt-8 text-center">
                <button id="generate-solution-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105">
                    Generate Solution
                </button>
            </div>
             <!-- Form Error Message -->
            <div id="form-error" class="text-red-600 text-sm mt-4 text-center h-5"></div>
        </main>

        <!-- Solution Section -->
        <section id="solution-container" class="mt-8">
            <div id="solution-placeholder" class="text-center p-8 bg-green-50 border-2 border-dashed border-green-200 rounded-2xl">
                <h2 class="text-xl font-medium text-green-800">Your personalized solution will appear here.</h2>
                <p class="text-gray-500 mt-1">Fill out the details above and click 'Generate Solution' to get started.</p>
            </div>
            <div id="solution-output" class="hidden" aria-live="polite"></div>
        </section>

    </div>

    <script src="logic.js"></script>
    <script>
        const generateBtn = document.getElementById('generate-solution-btn');
        const solutionContainer = document.getElementById('solution-container');
        const solutionPlaceholder = document.getElementById('solution-placeholder');
        const solutionOutput = document.getElementById('solution-output');
        const formError = document.getElementById('form-error');
        const dashboardBtn = document.getElementById('dashboard-btn');

        // Use the proxy endpoint for API calls
        const apiUrl = `/api/gemini`;

        generateBtn.addEventListener('click', generateSolution);
        dashboardBtn.addEventListener('click', backToDashboard);

        function backToDashboard() {
            // Navigate back to the main dashboard
            window.location.href = 'index.html';
        }

        function getFallbackFertilizerRecommendation(crop, soil, land, stage) {
            // Basic fallback recommendations
            const recommendations = {
                'Wheat': {
                    'Alluvial Soil': 'Use NPK 20-10-10 for sowing, followed by urea. Apply 50kg per acre.',
                    'Black Soil (Regur)': 'NPK 15-15-15 is suitable. Apply 40kg per acre with organic manure.',
                    'Red and Yellow Soil': 'Balanced NPK 17-17-17. Add lime if pH is low.'
                },
                'Rice': {
                    'Alluvial Soil': 'NPK 20-10-10 at transplanting, urea in splits. 60kg per acre.',
                    'Black Soil (Regur)': 'DAP and MOP with urea. Maintain flooded conditions.',
                    'Laterite Soil': 'Add phosphorus-rich fertilizers. Use organic matter.'
                },
                'Corn (Maize)': {
                    'Alluvial Soil': 'NPK 25-10-10. Apply in bands. 50kg per acre.',
                    'Black Soil (Regur)': 'High nitrogen requirement. Urea top dressing.',
                    'Red and Yellow Soil': 'Micronutrients may be needed. Test soil first.'
                }
            };

            const cropRec = recommendations[crop]?.[soil] || `For ${crop} in ${soil}, consult local agricultural extension for specific recommendations. Generally, balanced NPK fertilizers are suitable.`;
            return `**Recommended Fertilizer:** ${cropRec}\n\n**Application Method:** Broadcasting or side dressing.\n\n**Timing:** Apply at ${stage.toLowerCase()}.\n\n**Important Considerations:** Test soil pH and nutrient levels. Use organic amendments when possible.`;
        }

        function parseMarkdownToHtml(markdown) {
            let html = '';
            const lines = markdown.split('\n');
            let inList = false;

            for (const line of lines) {
                let trimmedLine = line.trim();
                
                // Headings (##, ###)
                if (trimmedLine.startsWith('### ') || trimmedLine.startsWith('## ')) {
                    if (inList) { html += '</ul>\n'; inList = false; }
                    html += `<h3>${trimmedLine.replace(/^(###|##) /, '')}</h3>\n`;
                    continue;
                }

                // List items (*)
                if (trimmedLine.startsWith('* ')) {
                    if (!inList) { html += '<ul>\n'; inList = true; }
                    let listItem = trimmedLine.substring(2);
                    listItem = listItem.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    html += `<li>${listItem}</li>\n`;
                    continue;
                }

                if (inList) {
                    html += '</ul>\n';
                    inList = false;
                }

                if (trimmedLine) {
                    let paragraph = trimmedLine;
                    paragraph = paragraph.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    html += `<p>${paragraph}</p>\n`;
                }
            }
            
            if (inList) {
                html += '</ul>\n';
            }

            return html;
        }

        async function generateSolution() {
            // 1. Get user inputs
            const crop = document.getElementById('crop-selection').value;
            const soil = document.getElementById('soil-type').value;
            const land = document.getElementById('land-amount').value;
            const stage = document.getElementById('crop-stage').value;

            // Basic validation
            formError.textContent = '';
            if (!land || parseFloat(land) <= 0) {
                formError.textContent = 'Please enter a valid amount of land.';
                return;
            }

            // 2. Setup UI for loading state
            solutionPlaceholder.classList.add('hidden');
            solutionOutput.classList.remove('hidden');
            solutionOutput.innerHTML = '<div class="loader"></div><p class="text-center text-gray-600">Generating your personalized recommendation...</p>';
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // 3. Construct the prompt
            const systemPrompt = "You are an expert agronomist and soil scientist. Your goal is to provide clear, actionable, and safe fertilizer recommendations to farmers. Format the response with clear headings for each section (e.g., '## Recommended Fertilizer'). Use bullet points for lists. Be concise and practical.";
            
            const userQuery = `
                I need a detailed fertilizer recommendation based on the following information:
                - Crop: ${crop}
                - Soil Type: ${soil}
                - Land Area: ${land} acres
                - Current Crop Stage: ${stage}

                Please provide the following:
                1.  **Recommended Fertilizer:** Specify the best NPK (Nitrogen-Phosphorus-Potassium) ratio or specific fertilizer type (e.g., Urea, DAP, MOP). Provide the quantity needed for the specified land area.
                2.  **Application Method:** Describe the best way to apply the fertilizer (e.g., broadcasting, band placement, foliar spray).
                3.  **Timing:** When is the best time to apply it during the current crop stage?
                4.  **Reasoning:** Briefly explain why this recommendation is suitable for the given crop, soil, and stage.
                5.  **Important Considerations:** Add any crucial safety or environmental precautions.
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 2048,
                },
            };

            // 4. Call the Gemini API
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Try to get more specific error info from the response body
                    let errorDetails = `API Error: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.error?.message || JSON.stringify(errorData);
                    } catch (e) {
                        // Ignore if response body is not JSON
                    }
                    throw new Error(errorDetails);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const generatedText = candidate.content.parts[0].text;
                    const formattedHtml = parseMarkdownToHtml(generatedText);

                    solutionOutput.innerHTML = `
                        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg solution-card">
                            <div class="flex justify-between items-center border-b pb-2 mb-4">
                                <h2 class="text-2xl font-bold text-green-800">Your Fertilizer Recommendation</h2>
                                <button id="start-over-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-lg transition">Start Over</button>
                            </div>
                            ${formattedHtml}
                        </div>
                    `;

                    document.getElementById('start-over-btn').addEventListener('click', () => {
                        solutionOutput.classList.add('hidden');
                        solutionOutput.innerHTML = '';
                        solutionPlaceholder.classList.remove('hidden');
                    });

                } else {
                     throw new Error('No valid content received from the API.');
                }

            } catch (error) {
                console.error("Error fetching solution:", error);
                // Provide fallback response with more details
                const fallbackResponse = getFallbackFertilizerRecommendation(crop, soil, land, stage);
                solutionOutput.innerHTML = `
                    <div class="bg-yellow-50 p-6 rounded-2xl border border-yellow-200">
                        <h3 class="text-xl font-bold text-yellow-700">AI Unavailable</h3>
                        <p class="text-yellow-600 mt-2">Our AI service is temporarily unavailable. This can be due to an invalid API key, network issues, or high traffic. Please check your API key configuration and try again.</p>
                        <div class="mt-4 bg-yellow-100 p-3 rounded-lg">
                           <p class="text-sm font-semibold text-yellow-800">Error Details:</p>
                           <p class="text-sm text-gray-600 mt-1 font-mono">${error.message}</p>
                        </div>
                        <p class="text-yellow-600 mt-4">In the meantime, here is a general recommendation based on standard agricultural practices:</p>
                        <div class="mt-4">${parseMarkdownToHtml(fallbackResponse)}</div>
                    </div>
                `;
            } finally {
                // 5. Reset UI
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Solution';
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    </script>

</body>
</html>

